# (PART\*) Running The Class {-}

# Overview {#run-class}

This section describes how to get your students set up to access AnVIL.  These steps will need to be *repeated for each new offering of the course*.

<br>

::: {.notice}
**Notify Terra**

In addition to setting up your class, you may want to contact Terra to [submit a request](https://support.terra.bio/hc/en-us/requests/new) for a hold on scheduled maintenance and downtime.  Contacting Terra ahead of your class time helps the Terra team avoid any major disruptions to your class.  It’s also a good idea to ask about major changes planned for the time prior to your class.
:::

# Set up Funding

As a reminder, Terra Billing Projects are how you grant people, including your students, permission to compute on AnVIL.  By adding someone to your Billing Project, you enable them to use your funding to carry out activities on AnVIL.

You *can* just add students to the same Billing Project that you are using yourself, but we generally recommend creating a separate Billing Project to fund student activity.  This makes it easy to deactivate when the course is over, without freezing your own projects.

Depending on how you are being funded, this may be taken care of for you. If your funding is being managed by a third party (e.g. through a funding mechanism such as [STRIDES](https://datascience.nih.gov/strides), or through your institution), contact them to determine whether you should create a Terra Billing Project for your students.

:::{.warning}
Regardless of who is managing funding, it is essential to make sure that you have permission to create enough Workspaces for all of your students!

To prevent abuse, new users are only permitted to create a few Workspaces.  See [Request Quota Increase](#quota-increase) for more information about how to make sure your students will be able to create Workspaces.
:::

## Create Student Billing Project

**Note:** Terra Billing Projects need unique names.  One option is to use a combination of institution-class-role-term (e.g. `jhu-bio101-students-2023FA`).

To create a Terra Billing Project:

:::: {.borrowed_chunk}
```{r, echo = FALSE, results='asis'}
cow::borrow_chapter(
  doc_path = "child/_child_terra_billing_project_create.Rmd",
  repo_name = "jhudsl/AnVIL_Template"
)
```
::::

::: {.notice}
**Reminder**: It's often a good idea to add at least one other Owner of a Billing Project in order to avoid getting locked out, in case the original owner loses access to their account.  See the section on [adding instructors to a billing project](#add-instructors-billing-project) if you need a reminder on how to do this.
:::

## Request Quota Increase {#quota-increase}

To prevent abuse, new users are only permitted to create a few Workspaces.  If each of your students needs their own Workspace (e.g. they each clone their own copy of a Workspace), you will quickly run into this limit and students will not be able to clone or create new Workspaces.

This limit is imposed by Google, rather than Terra (Google only permits you to create a few Google Cloud "Projects", and each Terra Workspace is a Google Cloud Project), so you will need to contact Google directly to request a "billing quota increase", using [this form](https://support.google.com/code/contact/billing_quota_increase).  This should be done by the owner of the Google Billing Account.  If you set up billing yourself, this is you; otherwise talk to your funding provider and make sure that you have enough Google Cloud Projects available for all your students (typically one per student, unless students need multiple Workspaces).

At the time of writing (Feb 2023) Terra is working to expedite this process for Terra users; we recommend checking the [relevant Terra documentation](https://support.terra.bio/hc/en-us/articles/6101030164507-When-workspace-creation-fails-Google-project-quotas) for the latest information as well as recommendations about how to fill out the form.

In our experience, the process has been reasonably straightforward and quick (approved in a couple of days).

# Create Student Group {#student-group}

Creating a Group for your students will let you easily manage the class as a whole by granting the Group access to Billing Projects and Workspaces.

You will need a unique name for your Group. We suggest a combination of institution-class-role-term (e.g., `jhu-bio101-students-2023FA`). Only letters, numbers, underscores, and dashes are allowed in Group names.

## Create Terra Group

To create a Group:

::::{.borrowed_chunk}
```{r, echo = FALSE, results='asis'}
cow::borrow_chapter(
  doc_path = "child/_child_terra_group_create.Rmd",
  branch = "add-terra-groups-modules",
  repo_name = "jhudsl/AnVIL_Template"
)
```
::::

You now have a unique **student Group**.

## Add Instructors to Group

Now that your student Group has been created, you should add any additional instructors / course coordinators as **Admins**.  This will give them permission to add and remove students, in case you are unavailable.

::: {.notice}
If you created an instructor Group, you can instead add the *Instructor Group* as an Admin of the *Student Group*.  This will enable everyone in the Instructor Group to act as an Admin for the Student Group.  To do this, you will need the email address associated with the Instructor Group, which can be found on the Group management page: https://anvil.terra.bio/#groups.
:::

To add someone to your group:

:::: {.borrowed_chunk}
```{r, echo = FALSE, results='asis'}
cow::borrow_chapter(
  doc_path = "child/_child_terra_group_add_member.Rmd",
  branch = "add-terra-groups-modules",
  repo_name = "jhudsl/AnVIL_Template"
)
```
::::


# Grant Students Access

The final step is to grant your students permission to access resources (Billing Projects and Workspaces) so that they can launch applications and perform computations on AnVIL.

<br>

::: {.warning}
Make sure you understand when and where your students can spend money!

The following actions will give your students the ability to spend money on AnVIL:

- Adding them to a **Billing Project** - this will let them create their own Workspaces
- Adding them as **Writers or Owners to a Workspace** - this will let them compute in the Workspace
:::

Our recommendation is to **do the following steps ahead of time**:

- Have students create accounts
- Add students to the Student Group
- Give the Student Group access to any Workspaces **as Readers**.  This will let them view the contents of the Workspace but not spend money in it.

**Wait until shortly before the students need to compute** to add the Student Group to the Billing Project.  This prevents them from starting something up early and then accruing costs by failing to shut it down.

## Have Students Create Accounts

Each of your students will need to:

1. Create a Google account, if they do not already have one
2. Sign in to Terra
3. Provide you with their username, so that you can add them to your Student Group

Student-facing instructions for account creation (and several other activities) are provided in the [**Student Instructions**](#student-instructions) section.

## Add Students to Group

Once your students have accounts, you will need to add them to your Student Group as **Members**.

::: {.notice}
In order to add students to your Group, you will need the usernames for the Google accounts your students are using to access AnVIL.
:::

Unfortunately there is currently no way to add members to a Group in bulk, so you will need to add students to the group one-by-one.  You can make this a bit easier on yourself by having students request to join the Group, so that you just need to approve them.  Instructions for both methods are provided below.

### Add students yourself:

The following instructions explain how to add someone to a Terra Group.  You will want to add students to the Group as **Members**.

:::: {.borrowed_chunk}
```{r, echo = FALSE, results='asis'}
cow::borrow_chapter(
  doc_path = "child/_child_terra_group_add_member.Rmd",
  branch = "add-terra-groups-modules",
  repo_name = "jhudsl/AnVIL_Template"
)
```
::::

### Have students request to join

Having your students request to join the Group can make things easier if you have a large class. You will need to provide your students with the name of the Group so they can search for it and request to join.

## Add Student Group to Workspace(s)

Now that you have added students to the Group, you can easily share Terra resources with the entire Group.

First, you will need to give your Student Group access to any Workspaces that they will need.

If you are **using a Public Workspace** (most pre-made content uses Public Workspaces), **you can skip this step** - Public Workspaces are automatically available to everyone on AnVIL.  

If you have **Workspaces of your own** that your students will need to access, you should **add the Student Group to your Workspace as a *Reader***.

- Adding students as a Reader gives them permission to view the Workspace, and (once they have funding) to **clone their own copy**.  This will enable them to work safely in their own space without interfering with each other or overwriting anything in the original Workspace.
- Adding students to your Workspace(s) can safely be done ahead of time; as Readers they can't run computations and run up a bill.

To add the Student Group to the Workspace, you will need the Group email address, which can be found on the Group management page: https://anvil.terra.bio/#groups

The following instructions explain how to add someone to a Terra Workspace.  You will want to add students to the Workspace as **Readers**.

:::: {.borrowed_chunk}
```{r, echo = FALSE, results='asis'}
cow::borrow_chapter(
  doc_path = "child/_child_workspace_share.Rmd",
  branch = "add-terra-groups-modules",
  repo_name = "jhudsl/AnVIL_Template"
)
```
::::

Make sure the newly added Student Group displays “Member” under “Roles”.

## Add Student Group to Billing Project


# Group Email Lists

Note that your newly created Groups have Group emails associated with them. Take note of these Group emails. You will use them for granting access to your class Billing Projects and Workspaces. It saves you from having to add or revoke access to students one by one.

```{r, echo=FALSE, fig.alt='Screenshot of the Terra Group page. Emails associated with newly formed Groups have been highlighted.'}
ottrpal::include_slide("https://docs.google.com/presentation/d/1HHWg47Tg6miv_K7GNB6ZDTx-4Jc5IMl7APfFtD1Rqag/edit#slide=id.g100474897dd_0_96")
```

# Shutting Down
